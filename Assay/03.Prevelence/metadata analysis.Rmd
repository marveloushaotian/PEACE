---
title: "Metadata Analysis"
author: "Haotian Zheng"
date: "24/04/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(ggrepel)
library(ggplot2)
library(ggrepel)
library(gggenes)
library(gg.gap)
library(ggbreak)
library(ggthemes)
library(ggpubr)
library(gtools)
library(igraph)
library(RColorBrewer)
library(dplyr)
library(plyr)
library(reshape2)
library(pheatmap)
library(readxl)
library(tibble)
library(scales)
library(psych)
library(vegan)
library(tidyverse)
library(knitr)
library(stringr)
do.write <- F
options(scipen = 200)
color_my10 <- c("#EBEBF3","#F4EEEE","#0B89CF","#A7647A","#B4A9BC","#90A3BD","#39639B","#DF9599","#AACFDD","#D8757B")
color_my41 <- c("#e63946","#457b9d","#a8dadc","#f4a261","#e76f51","#ff6b6b","#e5989b","#4ecdc4","#9bc1bc","#3d5a80","#cbf3f0","#d3bcc0","#bfc0c0","#b2967d","#9db4c0","#74546a","#84a59d","#bee3db","#f28482","#89b0ae","#4ecdc4","#fe5f55","#68d8d6","#ffd5c2","#77bfa3","#b8d8d8","#f694c1","#f7b267","#58a4b0","#f2cc8f","#a5668b","#f5cb5c","#06aed5","#ed6a5a","#5ca4a9","#ff715b","#59c3c3","#f4a261","#e63946","#fcb9b2","#8ac6d0")
color_heatmap_bule_red <- c("#7E1712","#bd2113","#e3460c","#f07701","#f59525","#fccbb8","#f5e13a","#a3e2e1","#6ab7e1","#4f74bb","#472497")  # top_soil::red--blue
color_4 <- c("#03a94d","#3846a2","#03b4c5","#eb2c3a") #green, blue, light blue, red.
color_2 <- c("#04adef","#f15b2b") #sky blue, orange.
color10 <- c('#8DD3C7', '#FFFFB3', '#BEBADA', '#FB8072', '#80B1D3', '#FDB462', '#B3DE69', '#FCCDE5', '#BC80BD', '#CCEBC5', 'gray')
```

### import data.
```{r}
metadata_origin <- read_tsv("../../Results/00.Original_Data/00.meta_data/plsdb_filtered.tsv")

metadata <- read.delim("../../Results/00.Original_Data/00.meta_data/plsdb_metadata_mar.txt",header = T,check.names = F,sep = "\t")
combine_data <- read.table("../../Results/00.Original_Data/all_combined_data.txt",header = T,check.names = F,sep = "\t")
```

### filter data.
```{r}
metadata_iso_host <- metadata_origin %>% filter(metadata_origin$IsolationSource_BIOSAMPLE != "" | metadata_origin$Host_BIOSAMPLE != "")
metadata_iso_host$TAG <- paste(metadata_iso_host$IsolationSource_BIOSAMPLE,"_",metadata_iso_host$Host_BIOSAMPLE)
metadata_tag_order <- tapply(metadata_iso_host$TAG, metadata_iso_host$TAG, length) %>% as.data.frame() %>% rownames_to_column("TAG")
metadata_tag_order <- metadata_tag_order %>% dplyr::rename(Tag_count = ".")
metadata_tag_order2 <- metadata_tag_order %>% filter(metadata_tag_order$Tag_count > 9)
metadata_tag_order3 <- metadata_tag_order %>% filter(metadata_tag_order$Tag_count <= 9)

# metadata_pfamily <- metadata_origin %>% filter(metadata_origin$pmlst != "")
# metadata_pf <- str_split_fixed(metadata_pfamily$pmlst, " ", 2) %>% as.data.frame()
# metadata_pf_order <- tapply(metadata_pf$V1, metadata_pf$V1, length) %>% as.data.frame() %>% rownames_to_column("plasmidfinder")
# metadata_pf_order <- metadata_pf_order %>% dplyr::rename(Tag_count = ".")

library(mixtools)
f <- normalmixEM2comp(log10(metadata_tag_order$Tag_count), sigsqrd = c(1,2), mu = c(3,5), lambda = 0.5)
param <- 10^m$mu

ggplot(metadata_tag_order, aes(Tag_count)) +
    theme_bw() +
    geom_density() +
    # geom_vline(data = line_df, aes(xintercept = Length)) +
    # geom_text(data = line_df, aes(label = LengthS, y = Place, x = Length), hjust = -0.2, size = 3) +
    scale_x_log10(labels = COEF::fancy_scientific) +
    xlab("Count Number") +
    ylab("Density")




write.table(metadata_tag_order2, "../../Results/00.Original_Data/00.meta_data/plsdb_filtered_tag.txt", sep = "\t", row.names = F)
```


```{r}
# densiyu_qu <- read.delim("../../Results/00.Original_Data/00.meta_data/plsdb_filtered_tag.txt",header = T,sep = "\t")
# densiyu_qu$Tag_count <- as.character(densiyu_qu$Tag_count)
# ggplot(densiyu_qu,aes(TAG,Tag_density))+geom_point()+geom_smooth(method="loess")
```



### pheatmap.
#### host-subtype.

#### host-subtype.



#